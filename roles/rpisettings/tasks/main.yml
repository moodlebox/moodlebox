---

- name: Reduce memory split down to 16Mb, as we are on a headless system
  ansible.builtin.lineinfile:
    path: '/boot/firmware/config.txt'
    line: 'gpu_mem=16'
    insertafter: '^\[all\]'
    firstmatch: true
  notify:
    - Reboot box

- name: Enable shutdown/startup hardware button
  ansible.builtin.lineinfile:
    path: '/boot/firmware/config.txt'
    line: 'dtoverlay=gpio-shutdown'
    insertafter: '^# Additional overlays and parameters'
  notify:
    - Reboot box

- name: Copy systemd unit file to fix hostname at the very first boot
  ansible.builtin.template:
    src: 'etc/systemd/system/fix-hostname-once.j2'
    dest: '/etc/systemd/system/fix-hostname-once.service'
    mode: '0755'

- name: Copy script to fix hostname at the very first boot
  ansible.builtin.template:
    src: 'usr/local/sbin/fix-hostname-once.j2'
    dest: '/usr/local/sbin/fix-hostname-once.sh'
    mode: '0755'

- name: Limit journald file size to 16 megabytes
  ansible.builtin.blockinfile:
    path: '/etc/systemd/journald.conf.d/journald_moodlebox.conf'
    create: true
    mode: '0644'
    block: |
      [Journal]
      SystemMaxUse=16M
  notify:
    - Restart journald service

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
